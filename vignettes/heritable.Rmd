---
title: "heritable"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{heritable}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Motivation

A key goal in any breeding trial is calculate heritability, which describes the extent of which a trait of interest underpinned by genes.

`heritable` is the one-stop shop for heritability calculations in R. The aim of our package is to implement existing methods for heritability to aid reproducibility and reporting of it's calculations.  This vignette is a brief overview of `heritable`'s workflow and key features.

## Installation

Note that this package is under active development. You can install the development version of heritable from [GitHub](https://github.com/) with: 

``` r
# install.packages("pak")
pak::pak("anu-aagi/heritable")
```

```{r setup}
library(heritable)
```

### An overview

`heritable` works with model outputs from `asreml` and `lme4` and extracts the relevant variance components to calculate heritabililty. Let's work with  dataset that contains phenotypic measurements of downy mildew resistance of 89 lettuce genotypes across 3 locations (environments), with replicates. For demonstration purposes, we will use subset of single environment (`L2`)

```{r}
head(lettuce_phenotypes)

lettuce_subset <- lettuce_phenotypes |> 
  filter(loc == "L2")
```

 Let's visualise the experimental design:

```{r}
library(dplyr)
library(ggplot2)

# Create the field layout plot
ggplot(lettuce_subset, aes(x = gen, y = rep)) +
  geom_tile(aes(fill = y), color = "white") +
  scale_fill_gradient(high = "#006d2c", low = "#d4eac7", 
                      name = "Downy Mildew\nResistance") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 5),
    legend.position = "bottom"
  )
```

We also have access to a genomic relationship matrix (GRM) calculated from 300 genetic markers that we will use for narrow-sense heritability

```{r}
# View the structure of the GRM
dim(lettuce_GRM)
lettuce_GRM[1:5, 1:5]
```

## Fitting a single environment model

### Broad-sense heritability with asreml

For broad-sense heritability, we fit a model with genotype as a random effect:

```{r, eval=FALSE}
library(asreml)

# Fit model with genotype as random effect
model_asreml <- asreml(
  fixed = y ~ loc,
  random = ~ gen + loc:rep,
  data = lettuce_phenotypes
)

# Calculate broad-sense heritability using multiple methods
H2(model_asreml, target = "gen", method = c("Cullis", "Oakey", "Piepho"))
```

### Narrow-sense heritability with asreml and GRM

For narrow-sense heritability, we use the genomic relationship matrix with `vm()`:

```{r, eval=FALSE}
# Fit model with GRM for narrow-sense heritability
model_asreml_grm <- asreml(
  fixed = y ~ loc,
  random = ~ vm(gen, lettuce_GRM) + loc:rep,
  data = lettuce_phenotypes
)

# Calculate narrow-sense heritability
h2(model_asreml_grm, target = "gen", method = "Oakey")
```

### Broad-sense heritability with lme4

```{r, eval=FALSE}
library(lme4)

# Fit model with genotype as random effect
model_lmer <- lmer(
  y ~ loc + (1|gen) + (1|loc:rep),
  data = lettuce_phenotypes
)

# Calculate broad-sense heritability
H2(model_lmer, target = "gen", method = c("Cullis", "Oakey"))
```

## Heritability methods

`heritable` supports calculations of both narrow-sense ($h^2$) and broad-sense heritability ($H^2$) using a variety of methods for single environment breeding trials:
